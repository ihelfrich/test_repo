<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Research Lab | Frontier Trade Signals</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c141f;
      --panel: #111b2a;
      --panel-alt: #152235;
      --ink: #e9eef5;
      --muted: #8a96a8;
      --accent: #2f9c95;
      --accent-warm: #f4b34a;
      --grid: rgba(233, 238, 245, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Sora", sans-serif;
      background: radial-gradient(circle at 15% 20%, #152235 0%, #0c141f 55%, #0a111a 100%);
      color: var(--ink);
      min-height: 100vh;
    }

    nav {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: rgba(12, 20, 31, 0.9);
      border-bottom: 1px solid rgba(233, 238, 245, 0.06);
    }

    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
    }

    .logo {
      font-weight: 700;
      letter-spacing: 0.4px;
      color: var(--ink);
    }

    nav ul {
      display: flex;
      gap: 22px;
      list-style: none;
      flex-wrap: wrap;
    }

    nav a {
      color: var(--muted);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.4px;
      text-transform: uppercase;
    }

    nav a:hover {
      color: var(--ink);
    }

    header {
      padding: 32px clamp(20px, 4vw, 52px) 12px;
    }

    .title {
      font-size: clamp(28px, 3.5vw, 42px);
      margin-bottom: 8px;
    }

    .subtitle {
      color: var(--muted);
      max-width: 820px;
      line-height: 1.6;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(280px, 340px) 1fr;
      gap: 20px;
      padding: 16px clamp(20px, 4vw, 52px) 48px;
    }

    .panel {
      background: var(--panel);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(233, 238, 245, 0.06);
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.25);
    }

    .panel h2 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1.6px;
      color: var(--accent-warm);
      margin-bottom: 12px;
    }

    .method-card {
      border: 1px solid rgba(233, 238, 245, 0.08);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease;
      background: var(--panel-alt);
    }

    .method-card:hover {
      transform: translateY(-2px);
      border-color: rgba(47, 156, 149, 0.6);
    }

    .method-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(47, 156, 149, 0.35);
    }

    .method-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .method-desc {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
    }

    .control-group {
      margin-bottom: 14px;
    }

    label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(233, 238, 245, 0.12);
      background: #0f1825;
      color: var(--ink);
      font-family: inherit;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }

    .subhead {
      margin-top: 18px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.4px;
      color: var(--muted);
    }

    .network-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .metric-card {
      background: rgba(0, 0, 0, 0.18);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(233, 238, 245, 0.06);
    }

    .metric-card span {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .metric-card strong {
      font-size: 16px;
      font-family: "IBM Plex Mono", monospace;
      color: var(--ink);
    }

    .rank-card {
      margin-top: 12px;
      background: rgba(0, 0, 0, 0.18);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(233, 238, 245, 0.06);
    }

    .rank-card span {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .rank-card ol {
      margin-left: 18px;
      font-size: 12px;
      color: var(--ink);
      line-height: 1.5;
    }

    .chart-panel {
      background: var(--panel);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(233, 238, 245, 0.06);
    }

    #chart {
      width: 100%;
      height: 360px;
      border-radius: 12px;
      background: radial-gradient(circle at 20% 20%, rgba(47, 156, 149, 0.12), transparent 60%);
      border: 1px solid rgba(233, 238, 245, 0.08);
    }

    .explanation {
      margin-top: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(233, 238, 245, 0.06);
      font-size: 13px;
      line-height: 1.6;
      color: var(--muted);
    }

    .explanation strong {
      color: var(--ink);
    }

    .note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <div class="logo">Gravity Trade Analysis</div>
      <ul>
        <li><a href="landing.html">Home</a></li>
        <li><a href="index.html">Tool</a></li>
        <li><a href="trade-sphere.html">Trade Sphere</a></li>
        <li><a href="trade-map.html?v=20260115">Trade Map</a></li>
        <li><a href="policy-lab.html?v=20260115">Policy Lab</a></li>
        <li><a href="residual-surface.html">Residual Surface</a></li>
        <li><a href="model-lab.html">Model Lab</a></li>
        <li><a href="topology.html">Topology</a></li>
        <li><a href="advanced_topology.html">Research Lab</a></li>
        <li><a href="methodology.html">Methodology</a></li>
        <li><a href="https://github.com/ihelfrich/test_repo">GitHub</a></li>
      </ul>
    </div>
  </nav>

  <header>
    <h1 class="title">Research Lab: Frontier Trade Signals</h1>
    <p class="subtitle">
      A data-backed sandbox for interpreting trade dynamics. Each module below
      is grounded in observable metrics from the gravity residuals and topology fields,
      with clear explanations you can cite.
    </p>
  </header>

  <section class="layout">
    <div class="panel">
      <h2>Method Stack</h2>
      <div class="method-card active" data-method="residual">
        <div class="method-title">Residual Dispersion</div>
        <div class="method-desc">Where the gravity model fits tightly vs. where trade deviates.</div>
      </div>
      <div class="method-card" data-method="transport">
        <div class="method-title">Transport Shift (W1)</div>
        <div class="method-desc">Wasserstein-1 distance between residual distributions year-to-year.</div>
      </div>
      <div class="method-card" data-method="concentration">
        <div class="method-title">Network Concentration</div>
        <div class="method-desc">Export and import HHI to track dependence on a few hubs.</div>
      </div>
      <div class="method-card" data-method="topology">
        <div class="method-title">Topology Field</div>
        <div class="method-desc">Field variance and Betti proxies from the spatial residual grid.</div>
      </div>

      <h2 style="margin-top:18px;">Year Control</h2>
      <div class="control-group">
        <label for="yearSelect">Year <span id="yearLabel"></span></label>
        <select id="yearSelect"></select>
      </div>

      <div class="metric-grid">
        <div class="metric-card">
          <span>Total trade (USD M)</span>
          <strong id="totalTrade">-</strong>
        </div>
        <div class="metric-card">
          <span>Mean ln distance</span>
          <strong id="meanDist">-</strong>
        </div>
        <div class="metric-card">
          <span>Contiguity share</span>
          <strong id="contigShare">-</strong>
        </div>
        <div class="metric-card">
          <span>RTA coverage</span>
          <strong id="rtaShare">-</strong>
        </div>
      </div>

      <div class="subhead">Network diagnostics</div>
      <div class="network-grid">
        <div class="metric-card">
          <span>Density</span>
          <strong id="netDensity">-</strong>
        </div>
        <div class="metric-card">
          <span>Reciprocity</span>
          <strong id="netReciprocity">-</strong>
        </div>
        <div class="metric-card">
          <span>Assortativity</span>
          <strong id="netAssortativity">-</strong>
        </div>
        <div class="metric-card">
          <span>Clustering</span>
          <strong id="netClustering">-</strong>
        </div>
      </div>
      <div class="rank-card">
        <span>Top PageRank</span>
        <ol id="pagerankList"></ol>
      </div>
      <div class="note" id="networkNote"></div>

      <div class="note" id="dataNote">Loading research summaryâ€¦</div>
    </div>

    <div>
      <div class="chart-panel">
        <h2 id="chartTitle">Residual dispersion over time</h2>
        <canvas id="chart"></canvas>
        <div class="explanation" id="explanation"></div>
        <div class="note" id="summaryNote"></div>
      </div>
    </div>
  </section>

  <script>
    const dataUrl = new URL('data/research_summary.json', window.location.href).href;
    const networkUrl = new URL('data/network_metrics.json', window.location.href).href;
    const chart = document.getElementById('chart');
    const ctx = chart.getContext('2d');

    const yearSelect = document.getElementById('yearSelect');
    const yearLabel = document.getElementById('yearLabel');
    const totalTrade = document.getElementById('totalTrade');
    const meanDist = document.getElementById('meanDist');
    const contigShare = document.getElementById('contigShare');
    const rtaShare = document.getElementById('rtaShare');
    const netDensity = document.getElementById('netDensity');
    const netReciprocity = document.getElementById('netReciprocity');
    const netAssortativity = document.getElementById('netAssortativity');
    const netClustering = document.getElementById('netClustering');
    const pagerankList = document.getElementById('pagerankList');
    const networkNote = document.getElementById('networkNote');
    const dataNote = document.getElementById('dataNote');
    const explanation = document.getElementById('explanation');
    const summaryNote = document.getElementById('summaryNote');
    const chartTitle = document.getElementById('chartTitle');

    const methods = {
      residual: {
        label: 'Residual dispersion over time',
        metric: 'residual_std',
        description: 'Higher dispersion indicates larger deviations from the baseline gravity fit, highlighting sectors or dyads the model under-explains.',
        unit: 'log points'
      },
      transport: {
        label: 'Transport shift (Wasserstein-1)',
        metric: 'wasserstein_shift',
        description: 'Year-to-year distribution shift in residuals. Large values suggest structural changes not captured by covariates.',
        unit: 'distance'
      },
      concentration: {
        label: 'Export concentration (HHI)',
        metric: 'export_hhi',
        description: 'Higher HHI means dependence on fewer exporters. Compare export vs. import concentration for asymmetry.',
        unit: 'HHI'
      },
      topology: {
        label: 'Topology field variance',
        metric: 'field_variance',
        description: 'Variance of the residual field on the spatial grid. High values signal clustered deviations and possible fragmentation.',
        unit: 'field var'
      }
    };

    let payload = null;
    let networkPayload = null;
    let activeMethod = 'residual';

    function resizeCanvas() {
      chart.width = chart.clientWidth;
      chart.height = chart.clientHeight;
      drawChart();
    }
    window.addEventListener('resize', resizeCanvas);

    function formatNumber(value, digits = 2) {
      if (!Number.isFinite(value)) return '-';
      return value.toLocaleString(undefined, { maximumFractionDigits: digits });
    }

    function drawChart() {
      if (!payload) return;
      const method = methods[activeMethod];
      const years = payload.meta.years;
      const values = years.map(year => payload.metrics[String(year)][method.metric] || 0);
      const maxVal = Math.max(...values, 1e-6);
      const minVal = Math.min(...values, 0);

      ctx.clearRect(0, 0, chart.width, chart.height);

      const padding = 40;
      const width = chart.width - padding * 2;
      const height = chart.height - padding * 2;

      ctx.strokeStyle = 'rgba(233, 238, 245, 0.2)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, chart.height - padding);
      ctx.lineTo(chart.width - padding, chart.height - padding);
      ctx.stroke();

      ctx.beginPath();
      values.forEach((value, idx) => {
        const x = padding + (idx / (values.length - 1)) * width;
        const y = padding + (1 - (value - minVal) / (maxVal - minVal + 1e-6)) * height;
        if (idx === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.strokeStyle = '#2f9c95';
      ctx.lineWidth = 2;
      ctx.stroke();

      const selectedYear = parseInt(yearSelect.value, 10);
      const selectedIdx = years.indexOf(selectedYear);
      if (selectedIdx >= 0) {
        const x = padding + (selectedIdx / (values.length - 1)) * width;
        const y = padding + (1 - (values[selectedIdx] - minVal) / (maxVal - minVal + 1e-6)) * height;
        ctx.fillStyle = '#f4b34a';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.fillStyle = 'rgba(233, 238, 245, 0.6)';
      ctx.font = '11px "IBM Plex Mono", monospace';
      ctx.fillText(minVal.toFixed(2), padding, chart.height - padding + 16);
      ctx.fillText(maxVal.toFixed(2), padding, padding - 8);
    }

    function updateMetrics() {
      if (!payload) return;
      const year = yearSelect.value;
      const data = payload.metrics[year];
      yearLabel.textContent = year;

      totalTrade.textContent = formatNumber(data.total_trade, 0);
      meanDist.textContent = formatNumber(data.mean_ln_dist, 2);
      contigShare.textContent = formatNumber(data.contig_share * 100, 1) + '%';
      rtaShare.textContent = formatNumber(data.rta_share * 100, 1) + '%';

      const method = methods[activeMethod];
      const value = data[method.metric];
      chartTitle.textContent = method.label;
      explanation.innerHTML = `<strong>${method.label}</strong>: ${method.description}<br><br>` +
        `Selected year value: <strong>${formatNumber(value, 4)}</strong> ${method.unit}.`;

      const summary = payload.summary || {};
      summaryNote.textContent = summary.largest_shifts
        ? `Largest distribution shifts: ${summary.largest_shifts.join(', ')}`
        : '';

      updateNetworkMetrics();
      drawChart();
    }

    function updateNetworkMetrics() {
      if (!networkPayload) {
        netDensity.textContent = '-';
        netReciprocity.textContent = '-';
        netAssortativity.textContent = '-';
        netClustering.textContent = '-';
        pagerankList.innerHTML = '';
        networkNote.textContent = 'Network metrics not loaded; run scripts/14_network_metrics.py.';
        return;
      }

      const year = yearSelect.value;
      const entry = networkPayload.by_year?.[year];
      if (!entry) {
        netDensity.textContent = '-';
        netReciprocity.textContent = '-';
        netAssortativity.textContent = '-';
        netClustering.textContent = '-';
        pagerankList.innerHTML = '';
        networkNote.textContent = `No network metrics for ${year}.`;
        return;
      }

      const stats = entry.network_stats || {};
      netDensity.textContent = formatNumber(stats.density, 4);
      netReciprocity.textContent = formatNumber(stats.reciprocity, 4);
      netAssortativity.textContent = formatNumber(stats.assortativity, 4);
      netClustering.textContent = formatNumber(stats.global_clustering, 4);

      pagerankList.innerHTML = '';
      (entry.top_by_pagerank || []).slice(0, 5).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item[0]} (${formatNumber(item[1], 5)})`;
        pagerankList.appendChild(li);
      });

      networkNote.textContent = `Edges: ${formatNumber(stats.num_edges, 0)} | Countries: ${formatNumber(stats.num_countries, 0)}.`;
    }

    function setActiveMethod(key) {
      activeMethod = key;
      document.querySelectorAll('.method-card').forEach(card => {
        card.classList.toggle('active', card.dataset.method === key);
      });
      updateMetrics();
    }

    async function loadData() {
      try {
        const [summaryResult, networkResult] = await Promise.allSettled([
          fetch(dataUrl, { cache: 'no-store' }),
          fetch(networkUrl, { cache: 'no-store' })
        ]);

        if (summaryResult.status === 'fulfilled' && summaryResult.value.ok) {
          payload = await summaryResult.value.json();
          yearSelect.innerHTML = '';
          payload.meta.years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
          });
          yearSelect.value = payload.meta.years[payload.meta.years.length - 1];
          dataNote.textContent = `Source: ${payload.meta.source}. Rows: ${payload.meta.rows}.`;
        } else {
          throw new Error('Research summary unavailable.');
        }

        if (networkResult.status === 'fulfilled' && networkResult.value.ok) {
          networkPayload = await networkResult.value.json();
          networkNote.textContent = '';
        } else {
          networkPayload = null;
          networkNote.textContent = 'Network metrics not loaded; run scripts/14_network_metrics.py.';
        }

        updateMetrics();
        resizeCanvas();
      } catch (err) {
        console.warn('Research summary load failed', err);
        dataNote.textContent = 'Unable to load research summary; run scripts/11_unified_analysis_pipeline.py.';
      }
    }

    document.querySelectorAll('.method-card').forEach(card => {
      card.addEventListener('click', () => setActiveMethod(card.dataset.method));
    });
    yearSelect.addEventListener('change', updateMetrics);

    loadData();
  </script>
</body>
</html>
