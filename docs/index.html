<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Counterfactual Gravity Shock Explorer</title>
  <!-- Force rebuild: 2026-01-13 -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Sora:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg: #f4f1ea;
      --panel: #ffffff;
      --panel-alt: #f7f0e1;
      --ink: #132238;
      --muted: #556275;
      --accent: #f4b34a;
      --accent-dark: #c97d12;
      --cool: #2f9c95;
      --grid: rgba(19, 34, 56, 0.08);
      --shadow: rgba(19, 34, 56, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Sora", sans-serif;
      background: radial-gradient(circle at 15% 20%, #fff6dc 0%, #f4f1ea 48%, #e6efe7 100%);
      color: var(--ink);
      min-height: 100vh;
    }

    header {
      padding: 28px clamp(18px, 5vw, 64px) 16px;
    }

    .title {
      font-size: clamp(26px, 3.2vw, 40px);
      margin: 0 0 8px;
      letter-spacing: 0.2px;
    }

    .subtitle {
      margin: 0;
      max-width: 900px;
      color: var(--muted);
      line-height: 1.6;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(260px, 340px) 1fr;
      gap: 20px;
      padding: 12px clamp(18px, 5vw, 64px) 36px;
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 30px var(--shadow);
      border: 1px solid rgba(19, 34, 56, 0.06);
    }

    .panel h2 {
      margin: 0 0 12px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1.4px;
      color: var(--accent-dark);
    }

    .equation {
      font-family: "IBM Plex Mono", monospace;
      font-size: 12px;
      background: var(--panel-alt);
      padding: 12px;
      border-radius: 12px;
      line-height: 1.55;
      border: 1px solid rgba(19, 34, 56, 0.06);
    }

    .control-group {
      margin-top: 16px;
    }

    label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    label span {
      color: var(--ink);
      font-weight: 600;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(19, 34, 56, 0.12);
      font-family: inherit;
      background: #fff;
      color: var(--ink);
    }

    .note {
      font-size: 12px;
      line-height: 1.5;
      color: var(--muted);
      margin-top: 12px;
    }

    #viz {
      position: relative;
      height: 68vh;
      min-height: 420px;
      border-radius: 16px;
      border: 1px solid rgba(19, 34, 56, 0.08);
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.8), rgba(244, 241, 234, 0.6));
      overflow: hidden;
    }

    #tooltip {
      position: absolute;
      pointer-events: none;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(19, 34, 56, 0.92);
      color: #fefcf8;
      font-size: 12px;
      font-family: "IBM Plex Mono", monospace;
      opacity: 0;
      transition: opacity 0.15s ease;
      max-width: 240px;
    }

    .meta {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .meta strong {
      color: var(--ink);
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 12px;
    }

    .legend-bar {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #2f9c95, #f4b34a, #d1495b);
    }

    .leaderboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 18px;
    }

    .leaderboard h3 {
      margin: 0 0 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--cool);
    }

    .leaderboard ul {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .leaderboard li {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(19, 34, 56, 0.1);
    }

    .leaderboard span {
      color: var(--ink);
      font-weight: 600;
    }

    footer {
      padding: 0 clamp(18px, 5vw, 64px) 28px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }

      #viz {
        height: 56vh;
      }
    }

    nav {
      background: var(--panel);
      border-bottom: 1px solid var(--grid);
      padding: 12px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px var(--shadow);
    }

    nav .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 clamp(18px, 5vw, 64px);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav .logo {
      font-size: 15px;
      font-weight: 600;
      color: var(--ink);
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 24px;
      margin: 0;
      padding: 0;
    }

    nav a {
      color: var(--muted);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      transition: color 0.2s;
    }

    nav a:hover {
      color: var(--accent-dark);
    }

    @media (max-width: 768px) {
      nav ul {
        gap: 12px;
      }
      nav a {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <div class="logo">Gravity Trade Analysis</div>
      <ul>
        <li><a href="landing.html">Home</a></li>
        <li><a href="executive-summary.html">Summary</a></li>
        <li><a href="index.html">Tool</a></li>
        <li><a href="methodology.html">Methodology</a></li>
        <li><a href="https://github.com/ihelfrich/test_repo">GitHub</a></li>
      </ul>
    </div>
  </nav>

  <header>
    <h1 class="title">Counterfactual Gravity Shock Explorer</h1>
    <p class="subtitle">
      Explore bilateral trade responses under Anderson–van Wincoop (2003) gravity with
      multilateral resistance captured via exporter/importer fixed effects. Use the sliders to
      scale estimated trade‑cost elasticities and compare predicted trade against baseline.
    </p>
  </header>

  <section class="layout">
    <div class="panel">
      <h2>Model Core</h2>
      <div class="equation">
        X_ij = exp(α_i + δ_j − θ·ln(dist_ij) + β′Z_ij)<br />
        Z_ij = {contig, comlang, comcol, rta} + {GDP, POP}
      </div>

      <div class="control-group">
        <label for="yearSelect">Year <span id="yearValue"></span></label>
        <select id="yearSelect"></select>
      </div>

      <div class="control-group">
        <label for="metricSelect">Z‑Axis Metric <span id="metricValue"></span></label>
        <select id="metricSelect">
          <option value="actual">Actual Trade (log1p)</option>
          <option value="pred">Predicted Baseline (log1p)</option>
          <option value="cf">Predicted Counterfactual (log1p)</option>
          <option value="delta">Counterfactual Δ (level)</option>
          <option value="residual">Baseline Residual (level)</option>
        </select>
      </div>

      <div class="control-group">
        <label for="distSlider">Distance Elasticity <span id="distLabel">1.00×</span></label>
        <input id="distSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="control-group">
        <label for="contigSlider">Contiguity Effect <span id="contigLabel">1.00×</span></label>
        <input id="contigSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="control-group">
        <label for="langSlider">Common Language Effect <span id="langLabel">1.00×</span></label>
        <input id="langSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="control-group">
        <label for="colSlider">Colonial Link Effect <span id="colLabel">1.00×</span></label>
        <input id="colSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="control-group">
        <label for="rtaSlider">RTA Coverage Effect <span id="rtaLabel">1.00×</span></label>
        <input id="rtaSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="legend">
        <span>Loss</span>
        <div class="legend-bar"></div>
        <span>Gain</span>
      </div>

      <p class="note">
        Partial‑equilibrium counterfactual: fixed effects are held constant (no GE re‑balancing).
      </p>
    </div>

    <div class="panel">
      <h2>Trade Space</h2>
      <div id="viz">
        <div id="tooltip"></div>
      </div>
      <div class="meta" id="meta"></div>

      <div class="leaderboard">
        <div>
          <h3>Top Winners</h3>
          <ul id="winners"></ul>
        </div>
        <div>
          <h3>Top Losers</h3>
          <ul id="losers"></ul>
        </div>
      </div>
    </div>
  </section>

  <footer>
    Data: BACI bilateral totals + CEPII gravity v202211. Columnar source in
    <code>docs/data/baci_gravity_viz.parquet</code> with a JSON render payload for GitHub Pages.
  </footer>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";

    const dataUrl = new URL("data/baci_gravity_viz.json", window.location.href).href;
    const container = document.getElementById("viz");
    const tooltip = document.getElementById("tooltip");
    const meta = document.getElementById("meta");
    const winnersList = document.getElementById("winners");
    const losersList = document.getElementById("losers");

    const yearSelect = document.getElementById("yearSelect");
    const yearValue = document.getElementById("yearValue");
    const metricSelect = document.getElementById("metricSelect");
    const metricValue = document.getElementById("metricValue");

    const distSlider = document.getElementById("distSlider");
    const contigSlider = document.getElementById("contigSlider");
    const langSlider = document.getElementById("langSlider");
    const colSlider = document.getElementById("colSlider");
    const rtaSlider = document.getElementById("rtaSlider");

    const distLabel = document.getElementById("distLabel");
    const contigLabel = document.getElementById("contigLabel");
    const langLabel = document.getElementById("langLabel");
    const colLabel = document.getElementById("colLabel");
    const rtaLabel = document.getElementById("rtaLabel");

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0xf4f1ea, 110, 220);

    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 1, 500);
    camera.position.set(80, 55, 120);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;

    const axes = new THREE.AxesHelper(60);
    axes.material.transparent = true;
    axes.material.opacity = 0.5;
    scene.add(axes);

    const grid = new THREE.GridHelper(120, 8, 0x9aa6b2, 0xcad2dc);
    grid.position.y = -40;
    grid.material.transparent = true;
    grid.material.opacity = 0.5;
    scene.add(grid);

    let points = null;
    let pointMeta = [];
    const raycaster = new THREE.Raycaster();
    raycaster.params.Points.threshold = 1.4;
    const pointer = new THREE.Vector2();

    const state = {
      shocks: {
        dist: 1,
        contig: 1,
        lang: 1,
        col: 1,
        rta: 1,
      },
      metric: "actual",
      year: null,
    };

    const formatMultiplier = (value) => `${Number(value).toFixed(2)}×`;

    const updateLabels = () => {
      distLabel.textContent = formatMultiplier(state.shocks.dist);
      contigLabel.textContent = formatMultiplier(state.shocks.contig);
      langLabel.textContent = formatMultiplier(state.shocks.lang);
      colLabel.textContent = formatMultiplier(state.shocks.col);
      rtaLabel.textContent = formatMultiplier(state.shocks.rta);
      yearValue.textContent = state.year ? state.year : "";
      metricValue.textContent = metricSelect.options[metricSelect.selectedIndex].text;
    };

    const normalize = (value, min, max, span) => {
      if (max === min) return 0;
      return ((value - min) / (max - min) - 0.5) * span;
    };

    const colorFromDelta = (value, min, max) => {
      if (max === min) return new THREE.Color(0xf4b34a);
      const t = (value - min) / (max - min);
      const hue = (1 - t) * 0.48;
      const color = new THREE.Color();
      color.setHSL(hue, 0.6, 0.52);
      return color;
    };

    const formatNumber = (value) => {
      if (!Number.isFinite(value)) return "n/a";
      return value.toLocaleString(undefined, { maximumFractionDigits: 2 });
    };

    const log1p = (value) => Math.log(1 + Math.max(0, value));

    const buildPoints = (rows, ranges, metricField) => {
      const positions = new Float32Array(rows.length * 3);
      const colors = new Float32Array(rows.length * 3);
      pointMeta = [];

      rows.forEach((row, i) => {
        const x = normalize(row.ln_dist, ranges.ln_dist.min, ranges.ln_dist.max, 120);
        const y = normalize(row.ln_gdp_prod, ranges.ln_gdp_prod.min, ranges.ln_gdp_prod.max, 120);
        const z = normalize(row[metricField], ranges[metricField].min, ranges[metricField].max, 120);

        positions[i * 3] = x;
        positions[i * 3 + 1] = y;
        positions[i * 3 + 2] = z;

        const color = colorFromDelta(row.delta_pred, ranges.delta_pred.min, ranges.delta_pred.max);
        colors[i * 3] = color.r;
        colors[i * 3 + 1] = color.g;
        colors[i * 3 + 2] = color.b;

        pointMeta.push(row);
      });

      const geometry = new THREE.BufferGeometry();
      geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));
      geometry.setAttribute("color", new THREE.BufferAttribute(colors, 3));

      const material = new THREE.PointsMaterial({
        size: 1.8,
        vertexColors: true,
        transparent: true,
        opacity: 0.85,
      });

      if (points) {
        scene.remove(points);
      }
      points = new THREE.Points(geometry, material);
      scene.add(points);
    };

    const getRanges = (rows, metricField) => {
      const fields = ["ln_dist", "ln_gdp_prod", metricField, "delta_pred"];
      const ranges = {};
      fields.forEach((field) => {
        const values = rows.map((row) => row[field]);
        ranges[field] = {
          min: Math.min(...values),
          max: Math.max(...values),
        };
      });
      return ranges;
    };

    const updateLeaderboard = (rows) => {
      const sorted = [...rows].sort((a, b) => b.delta_pred - a.delta_pred);
      const winners = sorted.slice(0, 5);
      const losers = sorted.slice(-5).reverse();

      winnersList.innerHTML = winners
        .map((row) => `
          <li>
            <div>${row.iso_o} → ${row.iso_d}</div>
            <span>${formatNumber(row.delta_pred)}</span>
          </li>
        `)
        .join("");

      losersList.innerHTML = losers
        .map((row) => `
          <li>
            <div>${row.iso_o} → ${row.iso_d}</div>
            <span>${formatNumber(row.delta_pred)}</span>
          </li>
        `)
        .join("");
    };

    const updateMeta = (metaInfo, rows, totals, metricField) => {
      meta.innerHTML = `
        <div><strong>Dataset:</strong> ${metaInfo.source}</div>
        <div><strong>Years:</strong> ${metaInfo.years.join(", ")}</div>
        <div><strong>Top N:</strong> ${metaInfo.top_n}</div>
        <div><strong>Rows in view:</strong> ${rows.length}</div>
        <div><strong>Baseline total:</strong> ${formatNumber(totals.base)}</div>
        <div><strong>Counterfactual total:</strong> ${formatNumber(totals.cf)}</div>
        <div><strong>Δ total:</strong> ${formatNumber(totals.delta)}</div>
      `;
    };

    const fetchData = async () => {
      if (window.location.protocol === "file:") {
        throw new Error(
          "This page must be served from a web server. Run: python3 -m http.server --directory docs"
        );
      }
      const response = await fetch(dataUrl, { cache: "no-store" });
      if (!response.ok) {
        throw new Error(`Unable to load data payload (${response.status}).`);
      }
      return response.json();
    };

    const init = async () => {
      try {
        console.log('[INIT] Starting initialization...');
        meta.textContent = `Loading data from ${dataUrl} ...`;
        console.log('[INIT] Fetching data from:', dataUrl);
        const payload = await fetchData();
        console.log('[INIT] Data fetched successfully:', payload.rows.length, 'rows');
        const rows = payload.rows;
        const metaInfo = payload.meta;
        const coeffs = metaInfo.coefficients || {};
        console.log('[INIT] Coefficients:', coeffs);

        const getCoeff = (key) => (key in coeffs ? coeffs[key] : 0);

        const rowsByYear = rows.reduce((acc, row) => {
          if (!acc[row.year]) acc[row.year] = [];
          acc[row.year].push(row);
          return acc;
        }, {});

        const years = metaInfo.years;
        years.forEach((year) => {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });

        state.year = years[years.length - 1];
        yearSelect.value = state.year;
        metricSelect.value = state.metric;
        updateLabels();

        const applyScenario = () => {
          const year = parseInt(state.year, 10);
          const yearRows = rowsByYear[year] || [];

          const computed = yearRows.map((row) => {
            const deltaEta =
              (state.shocks.dist - 1) * getCoeff("ln_dist") * row.ln_dist +
              (state.shocks.contig - 1) * getCoeff("contig") * row.contig +
              (state.shocks.lang - 1) * getCoeff("comlang_off") * row.comlang_off +
              (state.shocks.col - 1) * getCoeff("comcol") * row.comcol +
              (state.shocks.rta - 1) * getCoeff("rta_coverage") * row.rta_coverage;

            const etaCf = row.base_eta + deltaEta;
            const tradeCf = Math.exp(etaCf);
            const deltaPred = tradeCf - row.trade_pred;

            return {
              ...row,
              trade_cf: tradeCf,
              delta_pred: deltaPred,
              residual: row.trade_value_usd_millions - row.trade_pred,
              z_actual: log1p(row.trade_value_usd_millions),
              z_pred: log1p(row.trade_pred),
              z_cf: log1p(tradeCf),
            };
          });

          let metricField = "z_actual";
          if (state.metric === "pred") metricField = "z_pred";
          if (state.metric === "cf") metricField = "z_cf";
          if (state.metric === "delta") metricField = "delta_pred";
          if (state.metric === "residual") metricField = "residual";

          const ranges = getRanges(computed, metricField);
          buildPoints(computed, ranges, metricField);
          updateLeaderboard(computed);

          const totals = computed.reduce(
            (acc, row) => {
              acc.base += row.trade_pred;
              acc.cf += row.trade_cf;
              return acc;
            },
            { base: 0, cf: 0 }
          );
          totals.delta = totals.cf - totals.base;

          updateMeta(metaInfo, computed, totals, metricField);
        };

        const updateState = () => {
          state.year = yearSelect.value;
          state.metric = metricSelect.value;
          state.shocks.dist = parseFloat(distSlider.value);
          state.shocks.contig = parseFloat(contigSlider.value);
          state.shocks.lang = parseFloat(langSlider.value);
          state.shocks.col = parseFloat(colSlider.value);
          state.shocks.rta = parseFloat(rtaSlider.value);
          updateLabels();
          applyScenario();
        };

        yearSelect.addEventListener("change", updateState);
        metricSelect.addEventListener("change", updateState);
        [distSlider, contigSlider, langSlider, colSlider, rtaSlider].forEach((control) =>
          control.addEventListener("input", updateState)
        );

        console.log('[INIT] Calling updateState for first render...');
        updateState();
        console.log('[INIT] First render complete, points created:', !!points);

        container.addEventListener("mousemove", (event) => {
          if (!points) return; // Guard against null points
          const rect = container.getBoundingClientRect();
          pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
          raycaster.setFromCamera(pointer, camera);
          const intersects = raycaster.intersectObject(points);
          if (intersects.length) {
            const idx = intersects[0].index;
            const row = pointMeta[idx];
            tooltip.style.opacity = 1;
            tooltip.style.left = `${event.offsetX + 12}px`;
            tooltip.style.top = `${event.offsetY + 12}px`;
            tooltip.innerHTML = `
              <div><strong>${row.iso_o} → ${row.iso_d}</strong> (${row.year})</div>
              <div>Actual: ${formatNumber(row.trade_value_usd_millions)} (USD M)</div>
              <div>Baseline: ${formatNumber(row.trade_pred)}</div>
              <div>Counterfactual: ${formatNumber(row.trade_cf)}</div>
              <div>Δ Predicted: ${formatNumber(row.delta_pred)}</div>
              <div>ln(dist): ${formatNumber(row.ln_dist)}</div>
            `;
          } else {
            tooltip.style.opacity = 0;
          }
        });
      } catch (err) {
        console.error('[INIT] ERROR:', err);
        meta.innerHTML = `
          <div><strong>Data load failed:</strong> ${err.message}</div>
          <div style="margin-top:10px;"><strong>Stack:</strong> <pre style="font-size:10px;overflow-x:auto;">${err.stack}</pre></div>
          <div style="margin-top:10px;"><strong>Fixes:</strong></div>
          <div>1) Serve via GitHub Pages (Settings → Pages → main /docs).</div>
          <div>2) Or run: python3 -m http.server --directory docs</div>
          <div>3) Then open: http://localhost:8000</div>
          <div>4) Check browser console (F12) for details</div>
        `;
      }
    };

    const animate = () => {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    };

    window.addEventListener("resize", () => {
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    });

    init();
    animate();
  </script>
</body>
</html>
