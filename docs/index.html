<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Counterfactual Gravity Shock Explorer</title>
  <!-- Force rebuild: 2026-01-13 -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Sora:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg: #f4f1ea;
      --panel: #ffffff;
      --panel-alt: #f7f0e1;
      --ink: #132238;
      --muted: #556275;
      --accent: #f4b34a;
      --accent-dark: #c97d12;
      --cool: #2f9c95;
      --grid: rgba(19, 34, 56, 0.08);
      --shadow: rgba(19, 34, 56, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Sora", sans-serif;
      background: radial-gradient(circle at 15% 20%, #fff6dc 0%, #f4f1ea 48%, #e6efe7 100%);
      color: var(--ink);
      min-height: 100vh;
    }

    header {
      padding: 28px clamp(18px, 5vw, 64px) 16px;
    }

    .title {
      font-size: clamp(26px, 3.2vw, 40px);
      margin: 0 0 8px;
      letter-spacing: 0.2px;
    }

    .subtitle {
      margin: 0;
      max-width: 900px;
      color: var(--muted);
      line-height: 1.6;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 14px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.4px;
      background: rgba(47, 156, 149, 0.12);
      color: #1d6f69;
    }

    .status::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .status.is-warning {
      background: rgba(244, 179, 74, 0.15);
      color: #a56a1a;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(260px, 340px) 1fr;
      gap: 20px;
      padding: 12px clamp(18px, 5vw, 64px) 36px;
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 30px var(--shadow);
      border: 1px solid rgba(19, 34, 56, 0.06);
    }

    .panel h2 {
      margin: 0 0 12px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1.4px;
      color: var(--accent-dark);
    }

    .equation {
      font-family: "IBM Plex Mono", monospace;
      font-size: 12px;
      background: var(--panel-alt);
      padding: 12px;
      border-radius: 12px;
      line-height: 1.55;
      border: 1px solid rgba(19, 34, 56, 0.06);
    }

    .model-note {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(47, 156, 149, 0.08);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      border: 1px solid rgba(19, 34, 56, 0.06);
    }

    .insight {
      margin-top: 16px;
      padding: 12px;
      border-radius: 12px;
      background: #fbf7ee;
      border: 1px solid rgba(19, 34, 56, 0.08);
      font-size: 12px;
      color: var(--muted);
    }

    .insight h3 {
      margin: 0 0 8px;
      font-size: 12px;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--ink);
    }

    .coef-table {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 6px 10px;
      align-items: baseline;
      font-family: "IBM Plex Mono", monospace;
      font-size: 11px;
    }

    .coef-table span {
      color: var(--ink);
    }

    .coef-table .muted {
      color: var(--muted);
      font-family: "Sora", sans-serif;
      font-size: 11px;
    }

    .dyad-line {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .control-group {
      margin-top: 16px;
    }

    label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    label span {
      color: var(--ink);
      font-weight: 600;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(19, 34, 56, 0.12);
      font-family: inherit;
      background: #fff;
      color: var(--ink);
    }

    .note {
      font-size: 12px;
      line-height: 1.5;
      color: var(--muted);
      margin-top: 12px;
    }

    #viz {
      position: relative;
      height: 68vh;
      min-height: 420px;
      border-radius: 16px;
      border: 1px solid rgba(15, 22, 34, 0.4);
      background: radial-gradient(circle at 20% 20%, #1c2a3b, #0e141c 60%, #0a0f15 100%);
      overflow: hidden;
    }

    #tooltip {
      position: absolute;
      pointer-events: none;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(19, 34, 56, 0.92);
      color: #fefcf8;
      font-size: 12px;
      font-family: "IBM Plex Mono", monospace;
      opacity: 0;
      transition: opacity 0.15s ease;
      max-width: 240px;
    }

    .meta {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .meta strong {
      color: var(--ink);
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 12px;
    }

    .legend-bar {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #4f9dd8, #f4b34a, #d1495b);
    }

    .axis-legend {
      display: grid;
      gap: 6px;
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
    }

    .axis-legend span {
      color: var(--ink);
      font-weight: 600;
    }

    .leaderboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 18px;
    }

    .leaderboard h3 {
      margin: 0 0 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--cool);
    }

    .leaderboard ul {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .leaderboard li {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(19, 34, 56, 0.1);
    }

    .leaderboard span {
      color: var(--ink);
      font-weight: 600;
    }

    footer {
      padding: 0 clamp(18px, 5vw, 64px) 28px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }

      #viz {
        height: 56vh;
      }
    }

    nav {
      background: var(--panel);
      border-bottom: 1px solid var(--grid);
      padding: 12px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px var(--shadow);
    }

    nav .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 clamp(18px, 5vw, 64px);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav .logo {
      font-size: 15px;
      font-weight: 600;
      color: var(--ink);
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 24px;
      margin: 0;
      padding: 0;
    }

    nav a {
      color: var(--muted);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      transition: color 0.2s;
    }

    nav a:hover {
      color: var(--accent-dark);
    }

    @media (max-width: 768px) {
      nav ul {
        gap: 12px;
      }
      nav a {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <div class="logo">Gravity Trade Analysis</div>
      <ul>
        <li><a href="landing.html">Home</a></li>
        <li><a href="executive-summary.html">Summary</a></li>
        <li><a href="index.html">Tool</a></li>
        <li><a href="trade-sphere.html">Trade Sphere</a></li>
        <li><a href="residual-surface.html">Residual Surface</a></li>
        <li><a href="model-lab.html">Model Lab</a></li>
        <li><a href="topology.html">Topology</a></li>
        <li><a href="advanced_topology.html">Research Lab</a></li>
        <li><a href="methodology.html">Methodology</a></li>
        <li><a href="https://github.com/ihelfrich/test_repo">GitHub</a></li>
      </ul>
    </div>
  </nav>

  <header>
    <h1 class="title">Counterfactual Gravity Shock Explorer</h1>
    <p class="subtitle">
      Explore bilateral trade responses across multiple gravity specifications. Use the sliders
      to scale estimated trade‑cost elasticities and compare predicted trade against baseline
      under alternative modeling assumptions.
    </p>
    <div class="status" id="status">Initializing data pipeline…</div>
  </header>

  <section class="layout">
    <div class="panel">
      <h2>Model Core</h2>
      <div class="equation">
        X_ij = exp(α_i + δ_j − θ·ln(dist_ij) + β′Z_ij)<br />
        Z_ij = {contig, comlang, comcol, rta} + {GDP, POP}
      </div>

      <div class="control-group">
        <label for="modelSelect">Model <span id="modelValue"></span></label>
        <select id="modelSelect"></select>
      </div>
      <div class="model-note" id="modelNote"></div>
      <div class="insight">
        <h3>Model Insight</h3>
        <div id="modelSummary">Loading model diagnostics…</div>
      </div>

      <div class="control-group">
        <label for="yearSelect">Year <span id="yearValue"></span></label>
        <select id="yearSelect"></select>
      </div>

      <div class="control-group">
        <label for="metricSelect">Z‑Axis Metric <span id="metricValue"></span></label>
        <select id="metricSelect">
          <option value="actual">Actual Trade (log1p)</option>
          <option value="pred">Predicted Baseline (log1p)</option>
          <option value="cf">Predicted Counterfactual (log1p)</option>
          <option value="delta">Counterfactual Δ (level)</option>
          <option value="residual">Baseline Residual (level)</option>
          <option value="pct">Counterfactual % (Δ / baseline)</option>
        </select>
      </div>

      <div class="control-group">
        <label for="colorSelect">Color By <span id="colorValue"></span></label>
        <select id="colorSelect">
          <option value="delta_pred">Counterfactual Δ</option>
          <option value="residual">Baseline Residual</option>
          <option value="pct_change">Counterfactual %</option>
        </select>
      </div>

      <div class="control-group">
        <label for="topN">Top Flows <span id="topNLabel"></span></label>
        <input id="topN" type="range" min="50" max="400" step="10" value="200" />
      </div>

      <div class="control-group">
        <label for="sizeScale">Point Size <span id="sizeLabel"></span></label>
        <input id="sizeScale" type="range" min="0.6" max="2.0" step="0.1" value="1.2" />
      </div>

      <div class="control-group">
        <label for="distSlider">Distance Elasticity <span id="distLabel">1.00×</span></label>
        <input id="distSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="control-group">
        <label for="contigSlider">Contiguity Effect <span id="contigLabel">1.00×</span></label>
        <input id="contigSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="control-group">
        <label for="langSlider">Common Language Effect <span id="langLabel">1.00×</span></label>
        <input id="langSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="control-group">
        <label for="colSlider">Colonial Link Effect <span id="colLabel">1.00×</span></label>
        <input id="colSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="control-group">
        <label for="rtaSlider">RTA Coverage Effect <span id="rtaLabel">1.00×</span></label>
        <input id="rtaSlider" type="range" min="0" max="2" step="0.05" value="1" />
      </div>

      <div class="legend">
        <span id="legendMin">Low</span>
        <div class="legend-bar"></div>
        <span id="legendMax">High</span>
      </div>

      <p class="note">
        Partial‑equilibrium counterfactual: fixed effects are held constant (no GE re‑balancing).
      </p>

      <div class="axis-legend">
        <div><span>X</span> Log distance (ln dist)</div>
        <div><span>Y</span> Log GDP product (ln gdp_o + ln gdp_d)</div>
        <div><span>Z</span> Selected metric</div>
      </div>

      <div class="insight">
        <h3>Dyad Insight</h3>
        <div id="dyadSummary">Hover a point to inspect a dyad.</div>
      </div>
    </div>

    <div class="panel">
      <h2>Trade Space</h2>
      <div id="viz">
        <div id="tooltip"></div>
      </div>
      <div class="meta" id="meta"></div>

      <div class="leaderboard">
        <div>
          <h3>Top Winners</h3>
          <ul id="winners"></ul>
        </div>
        <div>
          <h3>Top Losers</h3>
          <ul id="losers"></ul>
        </div>
      </div>
    </div>
  </section>

  <footer>
    Data: BACI bilateral totals + CEPII gravity v202211. Columnar source in
    <code>docs/data/baci_gravity_viz.parquet</code> with a JSON render payload for GitHub Pages.
    <div>Curated by Dr. Ian Helfrich.</div>
  </footer>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";

    const dataUrl = new URL("data/baci_gravity_viz.json", window.location.href).href;
    const container = document.getElementById("viz");
    const tooltip = document.getElementById("tooltip");
    const meta = document.getElementById("meta");
    const statusEl = document.getElementById("status");
    const winnersList = document.getElementById("winners");
    const losersList = document.getElementById("losers");
    const legendMin = document.getElementById("legendMin");
    const legendMax = document.getElementById("legendMax");

    const modelSelect = document.getElementById("modelSelect");
    const modelValue = document.getElementById("modelValue");
    const modelNote = document.getElementById("modelNote");
    const modelSummary = document.getElementById("modelSummary");
    const dyadSummary = document.getElementById("dyadSummary");
    const yearSelect = document.getElementById("yearSelect");
    const yearValue = document.getElementById("yearValue");
    const metricSelect = document.getElementById("metricSelect");
    const metricValue = document.getElementById("metricValue");
    const colorSelect = document.getElementById("colorSelect");
    const colorValue = document.getElementById("colorValue");
    const topNSlider = document.getElementById("topN");
    const topNLabel = document.getElementById("topNLabel");
    const sizeSlider = document.getElementById("sizeScale");
    const sizeLabel = document.getElementById("sizeLabel");

    const distSlider = document.getElementById("distSlider");
    const contigSlider = document.getElementById("contigSlider");
    const langSlider = document.getElementById("langSlider");
    const colSlider = document.getElementById("colSlider");
    const rtaSlider = document.getElementById("rtaSlider");

    const distLabel = document.getElementById("distLabel");
    const contigLabel = document.getElementById("contigLabel");
    const langLabel = document.getElementById("langLabel");
    const colLabel = document.getElementById("colLabel");
    const rtaLabel = document.getElementById("rtaLabel");

    const fallbackPayload = {
      meta: {
        source: "Fallback dataset (offline mode)",
        years: [2021],
        top_n: 3,
        model: "Anderson-van Wincoop (2003) gravity with exporter/importer FE (PPML)",
        default_model: "avw_ppml",
        notes: "Fallback only: live payload not available.",
        warning: "Live data unavailable; showing fallback sample.",
        models: {
          avw_ppml: {
            label: "Anderson-van Wincoop (2003) PPML with exporter/importer FE",
            notes: "Fallback sample; coefficients are illustrative only.",
            link: "log",
            coefficients: {
              ln_dist: -0.8,
              contig: 0.4,
              comlang_off: 0.3,
              comcol: 0.2,
              rta_coverage: 0.15,
            },
          },
        },
        coefficients: {
          ln_dist: -0.8,
          contig: 0.4,
          comlang_off: 0.3,
          comcol: 0.2,
          rta_coverage: 0.15,
        },
      },
      rows: [
        {
          year: 2021,
          iso_o: "USA",
          iso_d: "CHN",
          trade_value_usd_millions: 50000,
          trade_pred: 42000,
          trade_pred_avw_ppml: 42000,
          base_eta: Math.log(42000),
          base_eta_avw_ppml: Math.log(42000),
          log_trade: Math.log(1 + 50000),
          log_trade_pred: Math.log(1 + 42000),
          log_trade_gap: Math.log(1 + 50000) - Math.log(1 + 42000),
          ln_dist: 8.6,
          ln_gdp_o: 30.8,
          ln_gdp_d: 30.5,
          ln_gdp_prod: 61.3,
          contig: 0,
          comlang_off: 0,
          comcol: 0,
          rta_coverage: 0,
        },
        {
          year: 2021,
          iso_o: "DEU",
          iso_d: "FRA",
          trade_value_usd_millions: 32000,
          trade_pred: 35000,
          trade_pred_avw_ppml: 35000,
          base_eta: Math.log(35000),
          base_eta_avw_ppml: Math.log(35000),
          log_trade: Math.log(1 + 32000),
          log_trade_pred: Math.log(1 + 35000),
          log_trade_gap: Math.log(1 + 32000) - Math.log(1 + 35000),
          ln_dist: 6.1,
          ln_gdp_o: 29.5,
          ln_gdp_d: 29.2,
          ln_gdp_prod: 58.7,
          contig: 1,
          comlang_off: 0,
          comcol: 0,
          rta_coverage: 1,
        },
        {
          year: 2021,
          iso_o: "BRA",
          iso_d: "ARG",
          trade_value_usd_millions: 8500,
          trade_pred: 9100,
          trade_pred_avw_ppml: 9100,
          base_eta: Math.log(9100),
          base_eta_avw_ppml: Math.log(9100),
          log_trade: Math.log(1 + 8500),
          log_trade_pred: Math.log(1 + 9100),
          log_trade_gap: Math.log(1 + 8500) - Math.log(1 + 9100),
          ln_dist: 6.5,
          ln_gdp_o: 28.7,
          ln_gdp_d: 27.9,
          ln_gdp_prod: 56.6,
          contig: 1,
          comlang_off: 0,
          comcol: 0,
          rta_coverage: 1,
        },
      ],
    };

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0xf4f1ea, 110, 220);

    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 1, 500);
    camera.position.set(80, 55, 120);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;

    const axes = new THREE.AxesHelper(60);
    axes.material.transparent = true;
    axes.material.opacity = 0.8;
    scene.add(axes);

    const grid = new THREE.GridHelper(120, 10, 0x3d4a5e, 0x222d3d);
    grid.position.y = -40;
    grid.material.transparent = true;
    grid.material.opacity = 0.7;
    scene.add(grid);

    let pointsGroup = null;
    let pointMeta = [];
    let modelMeta = {};
    let modelKeys = [];
    let lastDyad = null;
    const raycaster = new THREE.Raycaster();
    raycaster.params.Points.threshold = 5.0;
    const pointer = new THREE.Vector2();

    const state = {
      shocks: {
        dist: 1,
        contig: 1,
        lang: 1,
        col: 1,
        rta: 1,
      },
      metric: "actual",
      colorMetric: "delta_pred",
      modelKey: null,
      year: null,
      topN: 200,
      sizeScale: 1.2,
    };

    const formatMultiplier = (value) => `${Number(value).toFixed(2)}×`;
    const formatSigned = (value) => `${value >= 0 ? "+" : ""}${value.toFixed(3)}`;
    const formatPercent = (value) => `${value >= 0 ? "+" : ""}${value.toFixed(1)}%`;

    const getActiveModel = () => {
      if (state.modelKey && modelMeta[state.modelKey]) {
        return modelMeta[state.modelKey];
      }
      if (modelKeys.length && modelMeta[modelKeys[0]]) {
        return modelMeta[modelKeys[0]];
      }
      return { label: "Gravity model", notes: "", coefficients: {}, link: "log" };
    };

    const buildModelSummary = () => {
      const activeModel = getActiveModel();
      const coeffs = activeModel.coefficients || {};
      const rows = [
        { label: "Distance (ln dist)", key: "ln_dist", type: "elasticity" },
        { label: "Contiguity", key: "contig", type: "binary" },
        { label: "Common language", key: "comlang_off", type: "binary" },
        { label: "Colonial link", key: "comcol", type: "binary" },
        { label: "RTA coverage", key: "rta_coverage", type: "binary" },
      ];
      const interpretation =
        activeModel.link === "log1p"
          ? "OLS log1p: exp(beta)-1 ≈ % change (approx.)"
          : "PPML log-link: exp(beta)-1 ≈ % change";

      modelSummary.innerHTML = `
        <div class="coef-table">
          <span class="muted">Term</span>
          <span class="muted">β</span>
          <span class="muted">Effect</span>
          ${rows
            .map((row) => {
              const beta = Number(coeffs[row.key] || 0);
              const effect =
                row.type === "binary"
                  ? formatPercent((Math.exp(beta) - 1) * 100)
                  : formatSigned(beta);
              return `
                <span>${row.label}</span>
                <span>${formatSigned(beta)}</span>
                <span>${effect}</span>
              `;
            })
            .join("")}
        </div>
        <div class="muted" style="margin-top:8px;">${interpretation}</div>
      `;
    };

    const buildDyadSummary = (row) => {
      if (!row) {
        dyadSummary.textContent = "Hover a point to inspect a dyad.";
        return;
      }
      const activeModel = getActiveModel();
      const coeffs = activeModel.coefficients || {};
      const partials = [
        { label: "Distance", value: (coeffs.ln_dist || 0) * row.ln_dist },
        { label: "Contiguity", value: (coeffs.contig || 0) * row.contig },
        { label: "Language", value: (coeffs.comlang_off || 0) * row.comlang_off },
        { label: "Colonial", value: (coeffs.comcol || 0) * row.comcol },
        { label: "RTA", value: (coeffs.rta_coverage || 0) * row.rta_coverage },
      ];
      dyadSummary.innerHTML = `
        <div class="dyad-line"><span>${row.iso_o} → ${row.iso_d}</span><span>${row.year}</span></div>
        <div class="dyad-line"><span>Predicted</span><span>${formatNumber(row.trade_pred)}</span></div>
        <div class="dyad-line"><span>Counterfactual</span><span>${formatNumber(row.trade_cf)}</span></div>
        <div class="dyad-line"><span>Δ (model)</span><span>${formatNumber(row.delta_pred)}</span></div>
        <div class="dyad-line"><span>Residual</span><span>${formatNumber(row.residual)}</span></div>
        <div style="margin-top:8px; font-weight:600; color: var(--ink);">Partial contributions (excl. FE)</div>
        ${partials
          .map((item) => `<div class="dyad-line"><span>${item.label}</span><span>${formatSigned(item.value)}</span></div>`)
          .join("")}
      `;
    };

    const updateLabels = () => {
      const activeModel = getActiveModel();
      distLabel.textContent = formatMultiplier(state.shocks.dist);
      contigLabel.textContent = formatMultiplier(state.shocks.contig);
      langLabel.textContent = formatMultiplier(state.shocks.lang);
      colLabel.textContent = formatMultiplier(state.shocks.col);
      rtaLabel.textContent = formatMultiplier(state.shocks.rta);
      modelValue.textContent = activeModel.label || "";
      modelNote.textContent = activeModel.notes || "";
      yearValue.textContent = state.year ? state.year : "";
      metricValue.textContent = metricSelect.options[metricSelect.selectedIndex].text;
      colorValue.textContent = colorSelect.options[colorSelect.selectedIndex].text;
      topNLabel.textContent = `${state.topN}`;
      sizeLabel.textContent = `${state.sizeScale.toFixed(1)}×`;

      if (state.colorMetric === "pct_change") {
        legendMin.textContent = "Lower %";
        legendMax.textContent = "Higher %";
      } else if (state.colorMetric === "residual") {
        legendMin.textContent = "Under";
        legendMax.textContent = "Over";
      } else {
        legendMin.textContent = "Loss";
        legendMax.textContent = "Gain";
      }
      buildModelSummary();
      if (lastDyad) {
        buildDyadSummary(lastDyad);
      }
    };

    const normalize = (value, min, max, span) => {
      if (max === min) return 0;
      return ((value - min) / (max - min) - 0.5) * span;
    };

    const colorFromValue = (value, min, max) => {
      if (max === min) return new THREE.Color(0xf4b34a);
      const t = (value - min) / (max - min);
      const hue = (1 - t) * 0.62;
      const color = new THREE.Color();
      color.setHSL(hue, 0.7, 0.55);
      return color;
    };

    const formatNumber = (value) => {
      if (!Number.isFinite(value)) return "n/a";
      return value.toLocaleString(undefined, { maximumFractionDigits: 2 });
    };

    const log1p = (value) => Math.log(1 + Math.max(0, value));

    const clearPoints = () => {
      if (!pointsGroup) return;
      pointsGroup.children.forEach((child) => {
        child.geometry.dispose();
        child.material.dispose();
      });
      scene.remove(pointsGroup);
      pointsGroup = null;
    };

    const buildPoints = (rows, ranges, metricField, colorField, sizeScale) => {
      clearPoints();
      pointMeta = rows;

      const values = rows.map((row) => row.trade_value_usd_millions);
      const sorted = [...values].sort((a, b) => a - b);
      const q1 = sorted[Math.floor(sorted.length * 0.33)] || 0;
      const q2 = sorted[Math.floor(sorted.length * 0.66)] || q1;

      const buckets = [
        { max: q1, size: 1.4 },
        { max: q2, size: 2.2 },
        { max: Infinity, size: 3.0 },
      ];

      const bucketData = buckets.map(() => ({ positions: [], colors: [], rowIndex: [] }));

      rows.forEach((row, idx) => {
        const x = normalize(row.ln_dist, ranges.ln_dist.min, ranges.ln_dist.max, 120);
        const y = normalize(row.ln_gdp_prod, ranges.ln_gdp_prod.min, ranges.ln_gdp_prod.max, 120);
        const z = normalize(row[metricField], ranges[metricField].min, ranges[metricField].max, 120);

        const color = colorFromValue(row[colorField], ranges[colorField].min, ranges[colorField].max);
        const bucketIndex = row.trade_value_usd_millions <= q1 ? 0 : row.trade_value_usd_millions <= q2 ? 1 : 2;

        bucketData[bucketIndex].positions.push(x, y, z);
        bucketData[bucketIndex].colors.push(color.r, color.g, color.b);
        bucketData[bucketIndex].rowIndex.push(idx);
      });

      pointsGroup = new THREE.Group();

      bucketData.forEach((bucket, idx) => {
        if (!bucket.positions.length) return;
        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute("position", new THREE.BufferAttribute(new Float32Array(bucket.positions), 3));
        geometry.setAttribute("color", new THREE.BufferAttribute(new Float32Array(bucket.colors), 3));
        geometry.setAttribute("rowIndex", new THREE.BufferAttribute(new Float32Array(bucket.rowIndex), 1));
        geometry.computeBoundingSphere();

        const material = new THREE.PointsMaterial({
          size: buckets[idx].size * sizeScale,
          sizeAttenuation: true,
          vertexColors: true,
          transparent: true,
          opacity: 0.9,
          blending: THREE.AdditiveBlending,
        });

        const cloud = new THREE.Points(geometry, material);
        pointsGroup.add(cloud);
      });

      scene.add(pointsGroup);
    };

    const getRanges = (rows, metricField, colorField) => {
      const fields = ["ln_dist", "ln_gdp_prod", metricField, colorField];
      const ranges = {};
      fields.forEach((field) => {
        const values = rows.map((row) => row[field]);
        ranges[field] = {
          min: Math.min(...values),
          max: Math.max(...values),
        };
      });
      return ranges;
    };

    const updateLeaderboard = (rows) => {
      const sorted = [...rows].sort((a, b) => b.delta_pred - a.delta_pred);
      const winners = sorted.slice(0, 5);
      const losers = sorted.slice(-5).reverse();

      winnersList.innerHTML = winners
        .map((row) => `
          <li>
            <div>${row.iso_o} → ${row.iso_d}</div>
            <span>${formatNumber(row.delta_pred)}</span>
          </li>
        `)
        .join("");

      losersList.innerHTML = losers
        .map((row) => `
          <li>
            <div>${row.iso_o} → ${row.iso_d}</div>
            <span>${formatNumber(row.delta_pred)}</span>
          </li>
        `)
        .join("");
    };

    const updateMeta = (metaInfo, rows, totals, metricField, colorField) => {
      const warning = metaInfo.warning
        ? `<div style="color:#a56a1a;"><strong>Notice:</strong> ${metaInfo.warning}</div>`
        : "";
      const activeModel = getActiveModel();
      meta.innerHTML = `
        ${warning}
        <div><strong>Dataset:</strong> ${metaInfo.source}</div>
        <div><strong>Model:</strong> ${activeModel.label || metaInfo.model}</div>
        <div><strong>Years:</strong> ${metaInfo.years.join(", ")}</div>
        <div><strong>Top N (dataset):</strong> ${metaInfo.top_n}</div>
        <div><strong>Top N (filter):</strong> ${state.topN}</div>
        <div><strong>Rows in view:</strong> ${rows.length}</div>
        <div><strong>Color:</strong> ${colorSelect.options[colorSelect.selectedIndex].text}</div>
        <div><strong>Baseline total:</strong> ${formatNumber(totals.base)}</div>
        <div><strong>Counterfactual total:</strong> ${formatNumber(totals.cf)}</div>
        <div><strong>Δ total:</strong> ${formatNumber(totals.delta)}</div>
      `;
    };

    const fetchData = async () => {
      if (window.location.protocol === "file:") {
        throw new Error(
          "This page must be served from a web server. Run: python3 -m http.server --directory docs"
        );
      }
      const response = await fetch(dataUrl, { cache: "no-store" });
      if (!response.ok) {
        throw new Error(`Unable to load data payload (${response.status}).`);
      }
      return response.json();
    };

    const init = async () => {
      try {
        console.log('[INIT] Starting initialization...');
        meta.textContent = `Loading data from ${dataUrl} ...`;
        statusEl.textContent = "Loading data…";
        statusEl.classList.remove("is-warning");
        console.log('[INIT] Fetching data from:', dataUrl);
        let payload;
        try {
          payload = await fetchData();
          statusEl.textContent = "Live data loaded";
        } catch (err) {
          console.warn('[INIT] Live data load failed, using fallback.', err);
          payload = fallbackPayload;
          statusEl.textContent = "Fallback sample loaded";
          statusEl.classList.add("is-warning");
        }
        console.log('[INIT] Data fetched successfully:', payload.rows.length, 'rows');
        const rows = payload.rows;
        const metaInfo = payload.meta;
        const models = metaInfo.models && Object.keys(metaInfo.models).length
          ? metaInfo.models
          : {
              default: {
                label: metaInfo.model || "Gravity model",
                notes: metaInfo.notes || "",
                link: "log",
                coefficients: metaInfo.coefficients || {},
              },
            };
        modelMeta = models;
        modelKeys = Object.keys(modelMeta);
        modelSelect.innerHTML = "";
        modelKeys.forEach((key) => {
          const option = document.createElement("option");
          option.value = key;
          option.textContent = modelMeta[key].label || key;
          modelSelect.appendChild(option);
        });
        const defaultModel = metaInfo.default_model && modelMeta[metaInfo.default_model]
          ? metaInfo.default_model
          : modelKeys[0];
        state.modelKey = defaultModel;
        modelSelect.value = state.modelKey;

        console.log('[INIT] Available models:', modelKeys);

        const getCoeff = (key) => {
          const coeffs = getActiveModel().coefficients || {};
          return key in coeffs ? coeffs[key] : 0;
        };

        buildModelSummary();

        const rowsByYear = rows.reduce((acc, row) => {
          if (!acc[row.year]) acc[row.year] = [];
          acc[row.year].push(row);
          return acc;
        }, {});

        const years = Array.isArray(metaInfo.years)
          ? metaInfo.years
          : [...new Set(rows.map((row) => row.year))].sort((a, b) => a - b);
        if (!years.length) {
          throw new Error("No years available in data payload.");
        }
        years.forEach((year) => {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });

        state.year = years[years.length - 1];
        yearSelect.value = state.year;
        metricSelect.value = state.metric;
        colorSelect.value = state.colorMetric;
        topNSlider.value = state.topN;
        sizeSlider.value = state.sizeScale;
        updateLabels();

        const applyScenario = () => {
          const year = parseInt(state.year, 10);
          const yearRows = rowsByYear[year] || [];
          const maxRows = yearRows.length || 1;
          topNSlider.max = maxRows;
          topNSlider.min = Math.min(50, maxRows);
          if (state.topN > maxRows) {
            state.topN = maxRows;
            topNSlider.value = state.topN;
            updateLabels();
          }
          if (state.topN < parseInt(topNSlider.min, 10)) {
            state.topN = parseInt(topNSlider.min, 10);
            topNSlider.value = state.topN;
            updateLabels();
          }

          const topRows = [...yearRows]
            .sort((a, b) => b.trade_value_usd_millions - a.trade_value_usd_millions)
            .slice(0, state.topN);

          const computed = topRows.map((row) => {
            const modelKey = state.modelKey;
            const tradePred =
              row[`trade_pred_${modelKey}`] !== undefined
                ? row[`trade_pred_${modelKey}`]
                : row.trade_pred;
            const baseEta =
              row[`base_eta_${modelKey}`] !== undefined
                ? row[`base_eta_${modelKey}`]
                : row.base_eta;
            const deltaEta =
              (state.shocks.dist - 1) * getCoeff("ln_dist") * row.ln_dist +
              (state.shocks.contig - 1) * getCoeff("contig") * row.contig +
              (state.shocks.lang - 1) * getCoeff("comlang_off") * row.comlang_off +
              (state.shocks.col - 1) * getCoeff("comcol") * row.comcol +
              (state.shocks.rta - 1) * getCoeff("rta_coverage") * row.rta_coverage;

            const etaCf = baseEta + deltaEta;
            const link = getActiveModel().link || "log";
            let tradeCf = link === "log1p" ? Math.expm1(etaCf) : Math.exp(etaCf);
            if (!Number.isFinite(tradeCf)) tradeCf = 0;
            tradeCf = Math.max(0, tradeCf);
            const deltaPred = tradeCf - tradePred;
            const pctChange = tradePred > 0 ? deltaPred / tradePred : 0;

            return {
              ...row,
              trade_pred: tradePred,
              base_eta: baseEta,
              trade_cf: tradeCf,
              delta_pred: deltaPred,
              residual: row.trade_value_usd_millions - tradePred,
              pct_change: pctChange,
              z_actual: log1p(row.trade_value_usd_millions),
              z_pred: log1p(tradePred),
              z_cf: log1p(tradeCf),
              z_pct: pctChange,
            };
          });

          let metricField = "z_actual";
          if (state.metric === "pred") metricField = "z_pred";
          if (state.metric === "cf") metricField = "z_cf";
          if (state.metric === "delta") metricField = "delta_pred";
          if (state.metric === "residual") metricField = "residual";
          if (state.metric === "pct") metricField = "z_pct";

          const colorField = state.colorMetric;
          const ranges = getRanges(computed, metricField, colorField);
          buildPoints(computed, ranges, metricField, colorField, state.sizeScale);
          updateLeaderboard(computed);

          const totals = computed.reduce(
            (acc, row) => {
              acc.base += row.trade_pred;
              acc.cf += row.trade_cf;
              return acc;
            },
            { base: 0, cf: 0 }
          );
          totals.delta = totals.cf - totals.base;

          updateMeta(metaInfo, computed, totals, metricField, colorField);
        };

        const updateState = () => {
          state.modelKey = modelSelect.value;
          state.year = yearSelect.value;
          state.metric = metricSelect.value;
          state.colorMetric = colorSelect.value;
          state.topN = parseInt(topNSlider.value, 10);
          state.sizeScale = parseFloat(sizeSlider.value);
          state.shocks.dist = parseFloat(distSlider.value);
          state.shocks.contig = parseFloat(contigSlider.value);
          state.shocks.lang = parseFloat(langSlider.value);
          state.shocks.col = parseFloat(colSlider.value);
          state.shocks.rta = parseFloat(rtaSlider.value);
          updateLabels();
          applyScenario();
        };

        modelSelect.addEventListener("change", updateState);
        yearSelect.addEventListener("change", updateState);
        metricSelect.addEventListener("change", updateState);
        colorSelect.addEventListener("change", updateState);
        [topNSlider, sizeSlider, distSlider, contigSlider, langSlider, colSlider, rtaSlider].forEach(
          (control) => control.addEventListener("input", updateState)
        );

        console.log('[INIT] Calling updateState for first render...');
        updateState();
        console.log('[INIT] First render complete, points created:', !!pointsGroup);

        renderer.domElement.addEventListener("mousemove", (event) => {
          if (!pointsGroup) return;
          const rect = renderer.domElement.getBoundingClientRect();
          pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
          raycaster.setFromCamera(pointer, camera);
          if (!pointsGroup) return;
          const intersects = raycaster.intersectObjects(pointsGroup.children);
          if (intersects.length) {
            const hit = intersects[0];
            const idxAttr = hit.object.geometry.getAttribute("rowIndex");
            const rowIndex = Math.round(idxAttr.getX(hit.index));
            const row = pointMeta[rowIndex];
            lastDyad = row;
            tooltip.style.opacity = 1;
            tooltip.style.left = `${event.clientX - rect.left + 12}px`;
            tooltip.style.top = `${event.clientY - rect.top + 12}px`;
            tooltip.innerHTML = `
              <div><strong>${row.iso_o} → ${row.iso_d}</strong> (${row.year})</div>
              <div>Actual: ${formatNumber(row.trade_value_usd_millions)} (USD M)</div>
              <div>Baseline: ${formatNumber(row.trade_pred)}</div>
              <div>Counterfactual: ${formatNumber(row.trade_cf)}</div>
              <div>Δ Predicted: ${formatNumber(row.delta_pred)}</div>
              <div>Δ %: ${(row.pct_change * 100).toFixed(2)}%</div>
              <div>ln(dist): ${formatNumber(row.ln_dist)}</div>
            `;
            buildDyadSummary(row);
          } else {
            tooltip.style.opacity = 0;
          }
        });
      } catch (err) {
        console.error('[INIT] ERROR:', err);
        statusEl.textContent = "Initialization error";
        statusEl.classList.add("is-warning");
        meta.innerHTML = `
          <div><strong>Data load failed:</strong> ${err.message}</div>
          <div style="margin-top:10px;"><strong>Stack:</strong> <pre style="font-size:10px;overflow-x:auto;">${err.stack}</pre></div>
          <div style="margin-top:10px;"><strong>Fixes:</strong></div>
          <div>1) Serve via GitHub Pages (Settings → Pages → main /docs).</div>
          <div>2) Or run: python3 -m http.server --directory docs</div>
          <div>3) Then open: http://localhost:8000</div>
          <div>4) Check browser console (F12) for details</div>
        `;
      }
    };

    const animate = () => {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    };

    window.addEventListener("resize", () => {
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    });

    init();
    animate();
  </script>
</body>
</html>
